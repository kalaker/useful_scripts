#!/usr/bin/env bash

#############################################################################
# This script adds the JMU LabPrint printers to a computer. This script has #
# been tested on Linux Mint 18 and macOS Sierra, but should reasonably work #
# on any *nix-based OS with CUPS. The printers are added as Generic         #
# PostScript devices.                                                       #
#                                                                           #
# Author: Kyle Laker <kyle@kylelaker.com>                                   #
# Copyright (c) 2016 Kyle Laker                                             #
# Licensed under the MIT License                                            #
#############################################################################

#------------------
# Global variables
#------------------
# Provides your public IP address as a string
ip_api_url="https://api.ipify.org"
# Name of the Black & White printer
bw_printer="LabPrintBW"
# Name of the color printer
color_printer="LabPrintColor"

#-----------
# Functions
#-----------

#--------------------------------------------------------------------------
# Adds the provided printer. Name is set to JMU-$1. Location is JMU Labs &
# Libraries. Driver is a Generic PostScript Driver.
# Custom options:
#   Duplex=DuplexNoTumble: A setting for enabling duplex printing
#   Option1=True: A setting (particularly on macOS) to enable duplex
#                 printing
#--------------------------------------------------------------------------
configure_printer() {
    local generic_ps_ppd="drv:///sample.drv/generic.ppd"
    local printer_location="JMU Labs & Libraries"
    local printer_uri="lpd://labremoteprint@labprint.jmu.edu/${1}"
    echo "    Adding printer: ${1}"
    lpadmin -p "JMU-${1}" -E\
        -v "${printer_uri}" \
        -L "${printer_location}"\
        -m "${generic_ps_ppd}"\
        -o "Duplex=DuplexNoTumble"\
        -o "Option1=True"
}

#------------------------------------------------------------------------
# Ensure the user is somehow connected to the campus network. All JMU IP
# addresses begin with 134.126
#------------------------------------------------------------------------
check_connected_to_jmu() {
    local ip_address
    ip_address="$(curl -s "${ip_api_url}")"
    [ "${ip_address#134.126}" != "${ip_address}" ]
}

#----------------------------------------------------------------------------
# Basically just for making it easier to list which printers are being added
#----------------------------------------------------------------------------
add_printers() {
    configure_printer "${bw_printer}"
    configure_printer "${color_printer}"
}

#--------------------------------------------------------------------------
# Ensures the current user has the privileges as part of the lpadmin group
# to be adding & configuring printers.
#--------------------------------------------------------------------------
check_group() {
     id -Gn | grep -q "\b_lpadmin\b\|\blpadmin\b\|\broot\b"
}

#--------------------------------------------------------------
# Controls the flow, main logic, and most output of the script
#--------------------------------------------------------------
main() {
    echo "==> About to configure the JMU LabPrint printers (${bw_printer} & ${color_printer})"
    if ! check_connected_to_jmu; then
        echo "!!! ERROR: Not on network. The printers have not been added."
        echo "==> In order to add and use the LabPrint printers, you must be"
        echo "    connected to the JMU network through a wired or wireless"
        echo "    connection or through the SSLVPN. You do not appear to be"
        echo "    connected through any of these methods. If you believe this"
        echo "    is incorrect, double check your settings and try again."
        exit 1
    fi
    if ! check_group; then
        echo "!!! ERROR: Improper permissions. The printers have not been added."
        echo "==> You do not have the required permissions to make modifications"
        echo "    to the printers on this computers. Please try running this again"
        echo "    as an administrator or with \`sudo\`."
        exit 2
    fi
    echo "==> Adding printers..."
    add_printers
    echo "==> The LabPrint printers have been added."
    exit 0
}

#-------------------------
# Actually run the script
#-------------------------
main
